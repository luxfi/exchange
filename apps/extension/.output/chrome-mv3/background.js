import{d as j,S as m,E as H,l as i,D as o,c as J,a as $,b as h,C as b,e as w,s as B,f as Q,B as q,g as X,h as Y,i as Z,j as F,k as ee,m as g,n as N,o as R,r as _,p as C,q as te,t as ae,u as ne,w as se,v as ie,K as re,x as oe,y as ce,z as de,A as ue}from"./chunks/selectors-BUmeSjL8.js";import{f as M,A as y}from"./chunks/focusOrCreateOnboardingTab-DYcC_QZo.js";import{i as le,f as ge}from"./chunks/isOnboardedSelector-CFJH4W1F.js";import{s as G,a as z}from"./chunks/chromeSidePanelUtils-C-UayZyk.js";import{i as pe}from"./chunks/_virtual_wxt-plugins-616OUkZS.js";async function u(e){var a;const t=e?(a=e[m])==null?void 0:a.newValue:(await chrome.storage.local.get(m))[m];if(!t)return;const n=JSON.parse(t);return Object.keys(n).forEach(s=>{n[s]=JSON.parse(n[s])}),n}async function v(){const e=await u();return e?le(e):!1}async function fe(){const e=await u();return e?j(e.userSettings.deviceAccessTimeout):void 0}async function he(){var e;try{const t=await u();return!t||!((e=t._persist)!=null&&e.version)?!0:t._persist.version<H}catch(t){return i.error(t,{tags:{file:"persistedStateUtils.ts",function:"areMigrationsPending"}}),!0}}const be={interactive:new Set([o.RequestAccount,o.SendTransaction,o.SignMessage,o.SignTypedData,o.UniswapOpenSidebar,o.RequestPermissions,o.SendCalls]),silent:new Set([o.ChangeChain,o.RevokePermissions,o.GetCapabilities])},p=new Map,l=new Map;chrome.runtime.onConnect.addListener(async e=>{const t=e.name,n=J(e);p.set(t,n);const a=l.get(t);if(a){for(const s of a)await n.sendMessage(s);l.delete(t)}e.onDisconnect.addListener(async()=>{p.delete(t)})});let O=!1;function we(){O||($.addAllMessageListener((e,t)=>{if(!T(t)){i.error(new Error("sender.tab id or url is not defined"),{tags:{file:"backgroundDappRequests.ts",function:"dappMessageListener"}});return}const n=e.type,a=t.tab.windowId,s=a.toString(),r=!!p.get(s);Ce(n)&&!r?Me({tabId:t.tab.id,windowId:a,onSuccess:()=>{L({message:e,sender:t})},onError:(c,d)=>{if(i.error(c,{tags:{file:"backgroundDappRequests.ts",function:"initMessageBridge"},extra:{action:"openSidePanel",fallbackOpened:d}}),!T(t)){i.error(new Error("Sender tab info unexpectedly invalid in error callback"),{tags:{file:"backgroundDappRequests.ts",function:"initMessageBridge"}});return}A({windowId:a,message:e,senderTabInfo:{id:t.tab.id,url:t.tab.url,favIconUrl:t.tab.favIconUrl}})}}):L({message:e,sender:t})}),h.addMessageListener(b.ErrorLog,async e=>{i.error(new Error(e.message),{tags:{file:e.fileName,function:e.functionName,...e.tags},extra:e.extra})}),h.addMessageListener(b.AnalyticsLog,async e=>{const t={method:e.tags.method??"",dappUrl:e.tags.dappUrl??""},n=e.message;switch(n){case w.UnsupportedMethodRequest:case w.UnrecognizedMethodRequest:case w.DeprecatedMethodRequest:B(n,t);break}}),h.addMessageListener(b.FocusOnboardingTab,()=>{M().catch(e=>i.error(e,{tags:{file:"backgroundDappRequests.ts",function:"contentScriptUtilityMessageListener"}}))}),O=!0)}async function Se(e,t){const n=Q(t.url);if(!n)return!1;if(await he())return i.debug("backgroundDappRequests","handleSilentBackgroundRequest","Migrations pending, skipping silent handling"),!1;switch(e.type){case o.ChangeChain:return me({request:e,dappUrl:n,tabId:t.id}).catch(()=>{}),!0;case o.RevokePermissions:return ye({request:e,dappUrl:n,tabId:t.id}).catch(()=>{}),!0;case o.GetCapabilities:return ke({request:e,tabId:t.id}).catch(()=>{}),!0;default:return!1}}async function me({request:e,dappUrl:t,tabId:n}){await C.init();const{activeConnectedAddress:a}=C.getDappInfo(t)??{},s=ne(F(e.chainId)),r=s?se.providers.getProvider(s):void 0,c=ie({provider:r,dappUrl:t,updatedChainId:s,requestId:e.requestId,activeConnectedAddress:a});await g.sendMessageToTab(n,c)}async function ye({request:e,dappUrl:t,tabId:n}){await C.init(),Object.keys(e.permissions).includes(te.EthAccounts)?(await ae(t),await g.sendMessageToTab(n,{type:R.RevokePermissionsResponse,requestId:e.requestId})):await g.sendMessageToTab(n,{type:R.ErrorResponse,error:N(_.methodNotFound()),requestId:e.requestId})}async function ke({request:e,tabId:t}){var n;try{const a=await u(),s=a?X(a,e.address):!1,r=a?a.userSettings.isTestnetModeEnabled??!1:!1,c=Y(),{chains:d}=Z({isTestnetModeEnabled:r,featureFlaggedChainIds:c}),P=((n=e.chainIds)==null?void 0:n.map(F))??d.map(W=>W.valueOf()),V=await ee({request:e,chainIds:P,hasSmartWalletConsent:s});await g.sendMessageToTab(t,V)}catch(a){i.error(a,{tags:{file:"backgroundDappRequests.ts",function:"handleGetCapabilities"},extra:{request:e}}),await g.sendMessageToTab(t,{type:R.ErrorResponse,error:N(_.internal()),requestId:e.requestId})}}async function L({message:e,sender:t}){var c,d;if(!T(t)){i.error(new Error("Invalid sender tab info in handleRequestAsync"),{tags:{file:"backgroundDappRequests.ts",function:"handleRequestAsync"},extra:{hasTab:!!t.tab,hasId:((c=t.tab)==null?void 0:c.id)!==void 0,hasUrl:!!((d=t.tab)!=null&&d.url)}});return}const n={id:t.tab.id,url:t.tab.url,favIconUrl:t.tab.favIconUrl},a=t.tab.windowId,s=a.toString();!p.get(s)&&await Se(e,n)||await Re({request:e,windowId:a,senderTabInfo:n})}async function Re({request:e,windowId:t,senderTabInfo:n}){const a=t.toString(),s=p.get(a),r={type:q.DappRequestReceived,dappRequest:e,senderTabInfo:n,isSidebarClosed:!s};if(s)try{await s.sendMessage(r)}catch(c){i.error(c,{tags:{file:"backgroundDappRequests.ts",function:"handleSidebarRequest"}}),A({windowId:t,message:e,senderTabInfo:n})}else A({windowId:t,message:e,senderTabInfo:n})}function Ce(e){return be.interactive.has(e)}function T(e){var t;return((t=e==null?void 0:e.tab)==null?void 0:t.id)!==void 0&&e.tab.url!==void 0}function Me({tabId:e,windowId:t,onSuccess:n,onError:a}){chrome.sidePanel.open({tabId:e},()=>{const s=chrome.runtime.lastError;s?ge(e,t).then(()=>{a(s,!0)}).catch(r=>{i.error(r,{tags:{file:"backgroundDappRequests.ts",function:"openSidePanelSync"},extra:{action:"fallbackToPopupWindow"}}),a(s,!1)}):n()})}function A({windowId:e,message:t,senderTabInfo:n}){var r;const a=e.toString();l.has(a)||l.set(a,[]);const s={type:q.DappRequestReceived,dappRequest:t,senderTabInfo:n,isSidebarClosed:!0};(r=l.get(a))==null||r.push(s)}const I={isOnboarded:!1},K=[];let k;async function ve(){return k||(k=Te()),k}async function Te(){try{const e=await u();e||i.debug("backgroundStore.ts","initInternal","Failed to read redux state from storage"),await D(e),chrome.storage.local.onChanged.addListener(async t=>{const n=await u(t);await D(n)})}catch(e){i.error(e,{tags:{file:"backgroundStore.ts",function:"init"}})}}async function D(e){e&&Ae(await v())}function Ae(e){e!==I.isOnboarded&&(I.isOnboarded=e,K.forEach(t=>t(e)))}function Ie(e){K.push(e)}const U={state:I,init:ve,addOnboardingChangedListener:Ie};function Ee(e){return e==null||typeof e=="function"?{main:e}:e}async function E(){await G({enabled:!0}),await z({openPanelOnActionClick:!0})}async function S(){await G({enabled:!1}),await z({openPanelOnActionClick:!1})}async function qe(e){e?await E():await S()}async function Pe(){await ce(),await de(),U.addOnboardingChangedListener(async e=>{await qe(e)}),chrome.runtime.setUninstallURL(ue.chromeExtensionUninstallUrl),await U.init()}function Oe(){let e=!1;we(),chrome.tabs.onActivated.addListener(n),chrome.tabs.onUpdated.addListener(n),chrome.action.onClicked.addListener(async()=>{await t()}),chrome.runtime.onInstalled.addListener(async()=>{await t()}),chrome.alarms.onAlarm.addListener(a=>{a.name===y&&re.lock().then(()=>{B(w.ChangeLockedState,{locked:!0,location:"background"})}).catch(s=>{i.error(s,{tags:{file:"background.ts",function:"alarms.onAlarm"}})})}),chrome.runtime.onConnect.addListener(a=>{a.name===y&&a.onDisconnect.addListener(async()=>{try{const s=await fe();if(s===void 0)return;chrome.alarms.create(y,{delayInMinutes:s}),i.debug("background","port.onDisconnect",`Scheduled auto-lock alarm for ${s} minutes`)}catch(s){i.error(s,{tags:{file:"background.ts",function:"port.onDisconnect"}})}})}),h.addMessageListener(b.ArcBrowserCheck,async a=>{e=!!a.isArcBrowser,a.isArcBrowser?await S():await v()?await E():await S()});async function t(){if(e){await M();return}await v()?await E():(await S(),await M())}async function n(){try{await oe.sendMessage({type:q.TabActivated})}catch{}}Pe().catch(a=>{i.error(a,{tags:{file:"background/background.ts",function:"initApp"}})})}const Le=Ee({type:"module",main(){Oe()}});function f(e,...t){}const De={debug:(...e)=>f(console.debug,...e),log:(...e)=>f(console.log,...e),warn:(...e)=>f(console.warn,...e),error:(...e)=>f(console.error,...e)};let x;try{pe(),x=Le.main(),x instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw De.error("The background crashed on startup!"),e}
