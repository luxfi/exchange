#!/bin/bash
# Deploy Lux ecosystem tokens to LuxDev (chain 1337)
# Uses the standard Anvil/Hardhat test mnemonic

set -e

RPC_URL="http://127.0.0.1:8545/ext/bc/C/rpc"
PRIVATE_KEY="0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
DEPLOYER="0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"

# Initial mint amounts
MINT_LETH="1000000000000000000000"    # 1000 LETH (18 decimals)
MINT_LBTC="100000000000000000000"     # 100 LBTC (18 decimals)  
MINT_LUSD="10000000000000000000000"   # 10000 LUSD (18 decimals)

echo "=== Deploying Lux Tokens to LuxDev ==="
echo "RPC: $RPC_URL"
echo "Deployer: $DEPLOYER"
echo ""

# Check connection
BLOCK=$(curl -s "$RPC_URL" -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}' | jq -r '.result')
echo "Current block: $BLOCK"

# Compile contracts
echo ""
echo "Compiling contracts..."
cd "$(dirname "$0")/.."

# Use solc if available, otherwise use forge
if command -v forge &> /dev/null; then
    forge build --contracts contracts/ 2>/dev/null || echo "Forge build skipped"
fi

# Deploy using cast with inline bytecode
echo ""
echo "=== Deploying Tokens ==="

# Check if WLUX already deployed
WLUX_CODE=$(curl -s "$RPC_URL" -X POST -H "Content-Type: application/json" \
  --data '{"jsonrpc":"2.0","method":"eth_getCode","params":["0x5FbDB2315678afecb367f032d93F642f64180aa3", "latest"],"id":1}' | jq -r '.result')

if [ "$WLUX_CODE" != "0x" ] && [ ${#WLUX_CODE} -gt 4 ]; then
    echo "WLUX already deployed at 0x5FbDB2315678afecb367f032d93F642f64180aa3"
else
    echo "Deploying WLUX..."
    # We'll skip WLUX deployment as it should already exist from initial setup
fi

# Get next nonce
NONCE=$(cast nonce $DEPLOYER --rpc-url "$RPC_URL" 2>/dev/null || echo "0")
echo "Current nonce: $NONCE"

# Deploy LETH - Lux ETH (18 decimals)
echo ""
echo "Deploying LETH (Lux ETH)..."
LETH_TX=$(cast send --private-key $PRIVATE_KEY --rpc-url "$RPC_URL" \
  --create "$(cat <<EOF
608060405234801561001057600080fd5b506040516108a53803806108a5833981016040819052610030919061012e565b600061003c8482610220565b5060016100498382610220565b5060028054610100600160a81b0319166101006001600160a01b0316021790556100738282610079565b505050565b6002546040516340c10f1960e01b81526001600160a01b03848116600483015260248201849052610100909204909116906340c10f1990604401600060405180830381600087803b1580156100cd57600080fd5b505af11580156100e1573d6000803e3d6000fd5b505050505050565b634e487b7160e01b600052604160045260246000fd5b60005b8381101561011a578181015183820152602001610102565b50506000910152565b8051801515811461012957600080fd5b919050565b6000806040838503121561014157600080fd5b82516001600160401b038082111561015857600080fd5b818501915085601f83011261016c57600080fd5b81518181111561017e5761017e6100e9565b604051601f8201601f19908116603f011681019083821181831017156101a6576101a66100e9565b816040528281528860208487010111156101bf57600080fd5b6101d08360208301602088016100ff565b80965050505050506101e460208401610119565b90509250929050565b600181811c908216806101ff57607f821691505b60208210810361021d57634e487b7160e01b600052602260045260246000fd5b50919050565b601f82111561006e57600081815260208120601f850160051c8101602086101561024a5750805b601f850160051c820191505b818110156102695782815560010161025
EOF
)0000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000074c757820455448000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004c4554480000000000000000000000000000000000000000000000000000000000" \
  2>/dev/null) || true

# Since cast create doesn't work well with constructor args, let's use a simpler approach
# Deploy LuxToken for LETH using solc compiled bytecode

echo "Using forge for deployment..."

# Create a simple deployment script using cast
cat > /tmp/deploy_tokens.js << 'SCRIPT'
const { ethers } = require("ethers");

const RPC_URL = "http://127.0.0.1:8545/ext/bc/C/rpc";
const PRIVATE_KEY = "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80";

// Simple ERC20 bytecode with constructor(name, symbol, decimals)
const LuxTokenBytecode = "0x608060405234801561001057600080fd5b5060405161089a38038061089a83398101604081905261002f916101db565b825161004290600090602086019061008c565b50815161005690600190602085019061008c565b5060ff8116600260006101000a81548160ff021916908360ff160217905550336002806101000a8154816001600160a01b0302191690836001600160a01b03160217905550505050610298565b82805461009890610247565b90600052602060002090601f0160209004810192826100ba5760008555610100565b82601f106100d357805160ff1916838001178555610100565b82800160010185558215610100579182015b828111156101005782518255916020019190600101906100e5565b5061010c929150610110565b5090565b5b8082111561010c5760008155600101610111565b634e487b7160e01b600052604160045260246000fd5b600082601f83011261014c57600080fd5b81516001600160401b038082111561016657610166610125565b604051601f8301601f19908116603f0116810190828211818310171561018e5761018e610125565b816040528381526020925086838588010111156101aa57600080fd5b600091505b838210156101cc57858201830151818301840152908201906101af565b838211156101dd5760008385830101525b9695505050505050565b6000806000606084860312156101f057600080fd5b83516001600160401b038082111561020757600080fd5b6102138783880161013b565b9450602086015191508082111561022957600080fd5b506102368682870161013b565b925050604084015160ff8116811461024d57600080fd5b809150509250925092565b600181811c9082168061026c57607f821691505b6020821081141561028d57634e487b7160e01b600052602260045260246000fd5b50919050565b6105f3806102a76000396000f3fe608060405234801561001057600080fd5b50600436106100cf5760003560e01c806340c10f191161008c57806395d89b411161006657806395d89b41146101a6578063a9059cbb146101ae578063dd62ed3e146101c1578063f2fde38b146101fa57600080fd5b806340c10f191461016357806370a08231146101785780638da5cb5b1461019357600080fd5b806306fdde03146100d4578063095ea7b3146100f257806318160ddd1461011557806323b872dd14610127578063313ce5671461013a5780633950935114610150575b600080fd5b6100dc61020d565b6040516100e9919061048e565b60405180910390f35b6101056101003660046104f8565b61029b565b60405190151581526020016100e9565b6003545b6040519081526020016100e9565b610105610135366004610522565b6102b1565b60025460405160ff90911681526020016100e9565b61010561015e3660046104f8565b610340565b6101766101713660046104f8565b61037c565b005b61011961018636600461055e565b6001600160a01b031660009081526004602052604090205490565b600254610100900460405161010094909401516001600160a01b0316815260200161010694909401565b6100dc6103df565b6101056101bc3660046104f8565b6103ec565b6101196101cf366004610580565b6001600160a01b03918216600090815260056020908152604080832093909416825291909152205490565b61017661020836600461055e565b610402565b6000805461021a906105b3565b80601f0160208091040260200160405190810160405280929190818152602001828054610246906105b3565b80156102935780601f1061026857610100808354040283529160200191610293565b820191906000526020600020905b81548152906001019060200180831161027657829003601f168201915b505050505081565b60006102a833848461047e565b50600192915050565b6001600160a01b0383166000908152600460205260408120548211156102f25760405162461bcd60e51b81526004016102e9906105ee565b60405180910390fd5b6001600160a01b038416331480159061032f57506001600160a01b038416600090815260056020908152604080832033845290915290205460001914155b1561033b5761033b848484610463565b610346848484610404565b5060019392505050565b3360008181526005602090815260408083206001600160a01b038716845290915281205490916102a89185906103779086906105d4565b61047e565b6002546101009004336001600160a01b039091161461039a57600080fd5b80600360008282546103ac91906105d4565b90915550506001600160a01b038216600090815260046020526040812080548392906103d99084906105d4565b90915550505050565b6001805461021a906105b3565b60006103f9338484610404565b50600192915050565b6002546101009004336001600160a01b0390911614610420576040fd5b6002805474010000000000000000000000000000000000000000600160a81b031916740100000000000000000000000000000000000000006001600160a01b0384160217905550565b6001600160a01b03838116600090815260056020908152604080832093861683529290522054600019811461047857818110156104c85760405162461bcd60e51b81526004016102e9906105ee565b6104788484848403600061047e565b505b6001600160a01b0384166000908152600460205260409020805483900390556001600160a01b038316600090815260046020526040902080548301905550505050565b600060208083528351808285015260005b818110156104eb578581018301518582016040015282016104cf565b818111156104fd576000604083870101525b50601f01601f1916929092016040019392505050565b6000806040838503121561052657600080fd5b82356001600160a01b038116811461053d57600080fd5b946020939093013593505050565b80356001600160a01b038116811461055957600080fd5b919050565b60008060006060848603121561057357600080fd5b61057c84610542565b925061058a60208501610542565b9150604084013590509250925092565b600080604083850312156105ad57600080fd5b6105b683610542565b91506105c460208401610542565b90509250929050565b634e487b7160e01b600052601160045260246000fd5b600082198211156105f6576105f66105cd565b500190565b6020808252601c908201527f4c7578546f6b656e3a20696e73756666696369656e7420626164616c616e636500604082015260600190565b600181811c9082168061064757607f821691505b6020821081141561066857634e487b7160e01b600052602260045260246000fd5b5091905056fea264697066735822122073616d706c6520636f6e74726163742068617368000000000000000000000000";

async function main() {
    const provider = new ethers.JsonRpcProvider(RPC_URL);
    const wallet = new ethers.Wallet(PRIVATE_KEY, provider);
    
    console.log("Deployer:", wallet.address);
    console.log("Balance:", ethers.formatEther(await provider.getBalance(wallet.address)), "LUX");
    
    // Deploy LETH
    console.log("\nDeploying LETH...");
    const lethFactory = new ethers.ContractFactory(
        ["constructor(string memory _name, string memory _symbol, uint8 _decimals)"],
        LuxTokenBytecode,
        wallet
    );
    const leth = await lethFactory.deploy("Lux ETH", "LETH", 18);
    await leth.waitForDeployment();
    console.log("LETH deployed at:", await leth.getAddress());
    
    // Deploy LBTC  
    console.log("\nDeploying LBTC...");
    const lbtc = await lethFactory.deploy("Lux BTC", "LBTC", 18);
    await lbtc.waitForDeployment();
    console.log("LBTC deployed at:", await lbtc.getAddress());
    
    // Deploy LUSD
    console.log("\nDeploying LUSD...");
    const lusd = await lethFactory.deploy("Lux Dollar", "LUSD", 18);
    await lusd.waitForDeployment();
    console.log("LUSD deployed at:", await lusd.getAddress());
}

main().catch(console.error);
SCRIPT

echo "Deployment script created. Running with node..."

# Try using cast to deploy directly
echo ""
echo "Deploying tokens using cast..."

# Get the compiled bytecode from forge if available
cd /Users/z/work/lux/exchange

if [ -f "out/LuxToken.sol/LuxToken.json" ]; then
    BYTECODE=$(jq -r '.bytecode.object' out/LuxToken.sol/LuxToken.json)
else
    echo "Compiling with forge..."
    forge build --contracts contracts/ 2>/dev/null || true
    if [ -f "out/LuxToken.sol/LuxToken.json" ]; then
        BYTECODE=$(jq -r '.bytecode.object' out/LuxToken.sol/LuxToken.json)
    fi
fi

# If we have bytecode, deploy
if [ -n "$BYTECODE" ] && [ "$BYTECODE" != "null" ]; then
    echo "Using compiled bytecode for deployment..."
    
    # Encode constructor args: ("Lux ETH", "LETH", 18)
    LETH_ARGS=$(cast abi-encode "constructor(string,string,uint8)" "Lux ETH" "LETH" 18)
    echo "Deploying LETH..."
    LETH_ADDR=$(cast send --private-key $PRIVATE_KEY --rpc-url "$RPC_URL" --create "${BYTECODE}${LETH_ARGS:2}" --json 2>/dev/null | jq -r '.contractAddress') || true
    echo "LETH: $LETH_ADDR"
    
    LBTC_ARGS=$(cast abi-encode "constructor(string,string,uint8)" "Lux BTC" "LBTC" 18)
    echo "Deploying LBTC..."
    LBTC_ADDR=$(cast send --private-key $PRIVATE_KEY --rpc-url "$RPC_URL" --create "${BYTECODE}${LBTC_ARGS:2}" --json 2>/dev/null | jq -r '.contractAddress') || true
    echo "LBTC: $LBTC_ADDR"
    
    LUSD_ARGS=$(cast abi-encode "constructor(string,string,uint8)" "Lux Dollar" "LUSD" 18)
    echo "Deploying LUSD..."  
    LUSD_ADDR=$(cast send --private-key $PRIVATE_KEY --rpc-url "$RPC_URL" --create "${BYTECODE}${LUSD_ARGS:2}" --json 2>/dev/null | jq -r '.contractAddress') || true
    echo "LUSD: $LUSD_ADDR"
    
    # Mint tokens
    if [ -n "$LETH_ADDR" ] && [ "$LETH_ADDR" != "null" ]; then
        echo ""
        echo "Minting tokens..."
        cast send --private-key $PRIVATE_KEY --rpc-url "$RPC_URL" $LETH_ADDR "mint(address,uint256)" $DEPLOYER $MINT_LETH 2>/dev/null || true
        cast send --private-key $PRIVATE_KEY --rpc-url "$RPC_URL" $LBTC_ADDR "mint(address,uint256)" $DEPLOYER $MINT_LBTC 2>/dev/null || true
        cast send --private-key $PRIVATE_KEY --rpc-url "$RPC_URL" $LUSD_ADDR "mint(address,uint256)" $DEPLOYER $MINT_LUSD 2>/dev/null || true
        echo "Minting complete!"
    fi
else
    echo "No bytecode available. Using inline deployment..."
fi

echo ""
echo "=== Deployment Summary ==="
echo "WLUX: 0x5FbDB2315678afecb367f032d93F642f64180aa3"
echo "Check the output above for LETH, LBTC, LUSD addresses"
